<!DOCTYPE html>
<html lang="en-US">


<!-- Mirrored from hs-furtwangen.github.io/GIS-WiSe-2020-2021/content/L3.2/ by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 04 Dec 2020 16:50:33 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="stylesheet" href="../../assets/css/styleb6a9.css?v=ea27abaf339b85bc83f8e9f02e46150f2ace2c25">
  <link rel="shortcut icon" type="image/x-icon" href="../../assets/faviconb6a9.ico?v=ea27abaf339b85bc83f8e9f02e46150f2ace2c25">
  <title>Grundlage interaktiver Systeme - Wintersemester 2020/2021</title>
</head>

<body>
  <header class="page-header" role="banner">
    <div class="page-header-inner main-content">
      <div class="logo-wrapper">
        <div class="logo"></div>
      </div>
      <h1 class="project-name"><a href="../../index.html">Grundlagen interaktiver Systeme</a></h1>
      <h2 class="project-tagline">für MIB und OMB – WiSe 2020/2021</h2>
      <em><a href="../index.html#1-html-und-css"><strong>1</strong> HTML und CSS</a></em>
      <em><a href="../index.html#2-typescript"><strong>2</strong> TypeScript</a></em>
      <em><a href="../index.html#3-server-und-datenbanken"><strong>3</strong> Server und Datenbanken</a></em>
    </div>
  </header>
  <main id="content" class="main-content content-wrapper" role="main">
    <h2 id="v-32-server-request-verarbeitung"><em>V</em> <strong>3.2</strong> Server Request Verarbeitung</h2>

<h2 id="url-modul">URL Modul</h2>

<p>Für diese Aufgabe benötigen Sie das <a href="https://www.w3schools.com/nodejs/nodejs_url.asp"><ins>URL Modul</ins></a> von Node.js.</p>

<p>Die Aufgabe des URL Moduls ist es, einen URL (Adresse einer Website oder Unterseite + zusätzliche Attribute) in einzelne, les- und verwendbare Teile aufzusplitten. So können u.a. Anfragen von Nutzern die per GET über eine URL an einen Server verschickt werden besser/einfacher weiterverarbeitet werden.</p>

<p>Diese Methode wird oft verwendet, um zum Beispiel eine Suchanfrage in einer Datenbank durchzuführen, oder Inforamtionen an ein Skript zu senden.</p>

<blockquote>
  <p><strong>Hinweis</strong> Node.js Module funktionieren ausschließlich serverseitig. Wenn Sie versuchen Node.js Module in Ihrem Client zu verwenden wird das nicht funktionieren.</p>
</blockquote>

<p>Um einen Server zu entwickeln, der Anfragen von Clients verarbeiten kann, brauchen Sie zunächst immer (wie in Aufgabe 8) das Modul <code class="language-plaintext highlighter-rouge">http</code>, damit Ihr Server über das HTTP Protokoll erreicht werden kann. Das Modul <code class="language-plaintext highlighter-rouge">url</code> hilft Ihnen, den query-String zu extrahieren und zu interpretieren. Beide Module können mit dem Schlüsselwort <code class="language-plaintext highlighter-rouge">import</code> geladen und einer Variablen zugewiesen werden, über welche auf die Funktionen und Objekte der jeweiligen Module zugegriffen werden kann. Das Symbol <code class="language-plaintext highlighter-rouge">*</code> gibt dabei an, dass sämtliche Funktionalität der Module importiert werden soll, hier könnte auch eine einschränkendere Auswahl getroffen werden, was die allgemeine Performance steigert (da dann nicht alle Teilmodule eines Moduls geladen werden).</p>

<p>Sie benötigen also in Ihrer Serverklasse <code class="language-plaintext highlighter-rouge">http</code> und <code class="language-plaintext highlighter-rouge">url</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">Http</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">http</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">Url</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">url</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="k">namespace</span> <span class="p">...</span> <span class="p">{</span>
    <span class="nx">Http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(...);</span>
<span class="p">}</span>
</code></pre></div></div>
<p><strong>Achtung:</strong> Wird <code class="language-plaintext highlighter-rouge">import</code> verwendet, geht TypeScript davon aus, dass ein eigenes, neues Modul erzeugt werden soll und fordert ggf. das Schlüsselwort <code class="language-plaintext highlighter-rouge">export</code> vor <code class="language-plaintext highlighter-rouge">namespace</code>, auch wenn es hier eigentlich bedeutungslos ist. Ein Fall ist bekannt bei dem dieses <code class="language-plaintext highlighter-rouge">export</code> eine Fehlerhafte js Datei erzeugt hat. Wenn das bei Ihnen auch der Fall ist, melden Sie sich bitte.</p>

<p>Viele der Standardmodule, wie <code class="language-plaintext highlighter-rouge">http</code> und <code class="language-plaintext highlighter-rouge">url</code>, sind in der <a href="https://nodejs.org/de/docs/">Node-Dokumentation</a> beschrieben.</p>

<blockquote>
  <ul>
    <li>Testen Sie nun folgenden Beispielcode auf Ihrem Node.js Server und stellen Sie sicher, dass Sie die aktuelle Version von Node typings installiert haben. Zum Aktualisieren führen Sie einfach <code class="language-plaintext highlighter-rouge">npm install --save-dev @types/node</code> im Terminal Ihres Servers aus.</li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>Wo soll ich den Code testen?</strong> Zunächst einmal lokal über einen im Terminal gestarteten node server. Fertige Anwendungen dann nochmal auf Ihrem Heroku Server. Hier finden Sie noch einmal den <a href="https://github.com/Plagiatus/GIS_SoSe2020/blob/master/Aufgabe08/Server/server.ts">Node-Server-Beispielcode</a> aus der letzten Aufgabe der größtenteils Ihrem Heroku Server entsprechen sollte. Für Beispielcode wie den folgenden, bietet es sich auch immer an, eine eigene Datei anzulegen und so ohne die Umstände des eigentlichen Codes ein wenig herumprobieren zu können.</p>
</blockquote>

<h3 id="import-des-url-moduls">Import des URL Moduls:</h3>

<pre><code class="language-TypeScript">//Diese Zeile bei den Import Statements hinzufügen:
import * as url from "url";
</code></pre>

<h3 id="url-anlegen-und-parsen">URL Anlegen und Parsen</h3>

<pre><code class="language-TypeScript">//Diesen Code innerhalb von einem aktiven Server testen:

let adresse: string = 'http://localhost:8080/default.htm?jahr=2017&amp;monat=february';
//Adresse parsen (umwandeln):
let q = url.parse(adresse, true);

/*Die parse Methode gibt ein Objekt zurück, dass die URL Eigenschaften enthält. So können die fest definierten Eigenschaften einer URL ausgelesen werden:*/
console.log(q.host);
console.log(q.pathname);
console.log(q.search);

/*Die query Eigenschaft gibt ein Ojekt zurück, dass alle query-string Parameter als Eigenschaften besitzt. So können beliebig gesendete Attribute ausgelesen werden:*/
var qdata = q.query;
console.log(qdata.monat);
</code></pre>

<h3 id="eigenschaften-des-url-objektes">Eigenschaften des URL Objektes</h3>

<blockquote>
  <p>Siehe auch nochmal <a href="../L08/index.html#uniform-resource-locator-url">das Diagramm zum URL aus A08</a></p>
</blockquote>

<p><img src="Properties_URL_Module.png" alt="properties of URL" /></p>

<blockquote>
  <ul>
    <li>Untersuchen Sie folgende Tabelle und vergleichen Sie mit dem Beispiel. Wie können Sie auf den Port des URL im Beispiel oben zugreifen? Wie auf das mitgelieferte Custom-Attribut <code class="language-plaintext highlighter-rouge">jahr</code>?</li>
    <li>Fangen Sie die URL eines Klienten ab und testen Sie, ob Sie einen über ein per HTML Formular und <code class="language-plaintext highlighter-rouge">GET</code> gesendeten URL in die Einzelteile zerlegen können.</li>
  </ul>
</blockquote>

<blockquote>
  <p><strong>Hinweis</strong> Es ist hilfreich auch den folgenden Absatz zu lesen bevor Sie mit dem Testen auf Ihrem Server anfangen.</p>
</blockquote>

<h2 id="handle-request">Handle Request</h2>

<blockquote>
  <p><strong>Hinweis</strong> Im Praktikum letztes Semester wurde angesprochen, dass Sie zusätzliche Videoressourcen hilfreich fänden. Folgende Videos von Prof. Jirka Dell’Oro Friedel beschäftigen sich mit dieser Thematik und helfen ein besseres Verständnis für die Serverseitige Verarbeitung von <code class="language-plaintext highlighter-rouge">GET</code> Anfragen aufzubauen, sind jedoch in dem bestehenden Kontext einer anderen Aufgabe eingebettet.</p>
</blockquote>
<div align="center"><video controls="" width="30%"> 
  <source src="http://games.hs-furtwangen.de/EIA2_Video/L06_V3_Implementation_Server1.mp4" type="video/mp4" /> 
<a href="http://games.hs-furtwangen.de/EIA2_Video/L06_V3_Implementation_Server1.mp4"></a>
</video> 
<video controls="" width="30%"> 
  <source src="http://games.hs-furtwangen.de/EIA2_Video/L06_V4_Implementation_Server2.mp4" type="video/mp4" /> 
<a href="http://games.hs-furtwangen.de/EIA2_Video/L06_V4_Implementation_Server2.mp4"></a>
</video> 
<video controls="" width="30%"> 
  <source src="http://games.hs-furtwangen.de/EIA2_Video/L06_V5_Implementation_Client.mp4" type="video/mp4" /> 
<a href="http://games.hs-furtwangen.de/EIA2_Video/L06_V5_Implementation_Client.mp4"></a>
</video>  
</div>

<ul>
  <li>Video 1: Einfachen Server (Ähnlich wie der Beispiel-Server aus A8) aufsetzen, einfaches Request Handling</li>
  <li>Video 2: Komplexeres Request Handling und Antwort an Client zurückschicken</li>
  <li>Video 3: Antwort des Servers auf dem Client verarbeiten</li>
</ul>

<p>Um Anfragen von Nutzern auf einem Server verarbeiten zu können, wurde auf dem <a href="https://github.com/Plagiatus/GIS_SoSe2020/blob/master/Aufgabe08/Server/server.ts"><ins>Beispiel-Node-Server</ins></a> der letzten Aufgabe folgender Event-Listener installiert:</p>

<pre><code class="language-TypeScript">server.addListener("request", handleRequest);
</code></pre>

<p>Dieser Listener ruft für jede eingehende Anfrage eines Nutzers die Funktion <code class="language-plaintext highlighter-rouge">handleRequest</code> auf, in der die Anfragen von Nutzern verarbeitet werden. Das Ganze erinnert an die Events die Sie aus dem DOM und den letzten Aufgaben gewöhnt sind.</p>

<p>Die Events die auf einem Node Server ankommen und verarbeitet werden sind jedoch keine DOM-Events! Schließlich ist HTML nicht die Grundlage auf der Serverseite, sondern Node.js. Deswegen folgen die Events in Node.js auch nicht der gewohnten Konvention, dass immer ein Event-Objekt an den Handler übergeben wird.</p>

<p>Der Handler zum Request-Event der Funktion <code class="language-plaintext highlighter-rouge">handleRequest</code> erwartet zwei Parameter:</p>
<ul>
  <li>Den ersten vom Typ <code class="language-plaintext highlighter-rouge">IncomingMessage</code></li>
  <li>Den zweiten vom Typ <code class="language-plaintext highlighter-rouge">ServerResponse</code>, beide aus dem <code class="language-plaintext highlighter-rouge">http</code>-Modul.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">IncomingMessage</code> liefert Informationen zum eingegangenen Request Objekt, zum Beispiel die URL als String. Um daraus bequem den Query-Teil zu extrahieren, bietet das <code class="language-plaintext highlighter-rouge">url</code>-Modul hilfreiche Methoden. <code class="language-plaintext highlighter-rouge">parse</code> interpretiert die URL und erzeugt daraus ein neues Objekt, dessen Eigenschaft <code class="language-plaintext highlighter-rouge">query</code> nun wieder ein assoziatives Array darstellt.</p>

<p><code class="language-plaintext highlighter-rouge">ServerResponse</code> ist ein Objekt, welches Informationen für die Antwort sammelt. Dabei wird, wie bei Kommunikationsprotokollen üblich, diese Information in zwei grundlegende Kategorien aufgeteilt:</p>

<ul>
  <li>Header: Information zur eigentlichen Nachricht</li>
  <li>Body: die Nachricht selbst.</li>
</ul>

<p>Header-Informationen integrieren Sie mit der Methode <code class="language-plaintext highlighter-rouge">setHeader(...)</code> des ServerResponse-Objektes. Mit <code class="language-plaintext highlighter-rouge">write(...)</code> können Sie ganz einfach Zeichenketten dem Nachrichten-Body anfügen und mit <code class="language-plaintext highlighter-rouge">end()</code> die Antwort an den Klienten verschicken lassen. Eine simple Antwort kann man also so zusammenbauen:</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">handleRequest</span><span class="p">(</span><span class="nx">_request</span><span class="p">:</span> <span class="nx">Http</span><span class="p">.</span><span class="nx">IncomingMessage</span><span class="p">,</span> <span class="nx">_response</span><span class="p">:</span> <span class="nx">Http</span><span class="p">.</span><span class="nx">ServerResponse</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="nx">_response</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">content-type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">text/html; charset=utf-8</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">_response</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Access-Control-Allow-Origin</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">*</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">_response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="dl">"</span><span class="s2">Was geht?</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">_response</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>
<p>In diesem Beispiel verschickt der Server lediglich die Antwort mit dem Inhalt <code class="language-plaintext highlighter-rouge">"Was geht?"</code>. Der Header gibt an, dass die Antwort ein mit utf-8 kodierter Text ist, also z.b. kein Bild, und dass sie von jedem geöffnet werden darf. Auch hier bedeutet der Asterisk <code class="language-plaintext highlighter-rouge">*</code> wieder “alles”.</p>

<h2 id="post-anfrage-serverseitig-auslesen-für-bonusaufgabe-relevant">Post Anfrage Serverseitig auslesen (für Bonusaufgabe relevant)</h2>

<p>Dieser Abschnitt ist weder Prüfungsrelevant, noch für die normalen Aufgaben -&gt; Er soll für ein verbessertes Verständnis zu serverseitiger POST-Verarbeitung für alle an der Bonusaufgabe Interessierten geben.</p>

<p>Die Methode <code class="language-plaintext highlighter-rouge">POST</code> in serverseitigen Anfragen zu verwenden bietet einige Vorteile (es kann trotzdem sinnvoll sein in manchen Fällen <code class="language-plaintext highlighter-rouge">GET</code> zu verwenden):</p>

<ul>
  <li>POST ist etwas sicherer als GET, da Informationen nicht in der Suchleiste angezeigt werden. Wenn zum Beispiel Passwörter oder Email-Adressen verschickt werden sollte immer POST verwendet werden.</li>
  <li>POST eignet sich besser für Anweisungsoperationen, wie zum Beispiel eine bestimmte Seite zu löschen, da die URL nie zufällig in die Suchleiste eingegeben werden kann. Eine Url wie z.B. <code class="language-plaintext highlighter-rouge">http://meineWebseite.de/unterseite/delete/123</code> die zum Beispiel das Bild Nr. 123 löscht, könnte versehentlich oder absichtlich in der Suchleiste angegeben werden und zum Löschen einer Datei führen.</li>
  <li>Mit POST können beliebig viele Daten verschickt werden. GET ist auf 2048 Zeichen beschränkt</li>
</ul>

<p>Die Verarbeitung von POST Anfragen in Node.js ist jedoch nicht ganz einfach. Hier sind zwei hilfreiche Ressourcen, um POST-Anfragen serverseitig verabeiten zu können, ansonsten können Sie sich auch direkt den weiter unten stehenden Beispielcode ansehen.</p>

<ul>
  <li><a href="https://itnext.io/how-to-handle-the-post-request-body-in-node-js-without-using-a-framework-cd2038b93190">POST Daten ohne extentions auslesen</a></li>
  <li><a href="https://stackoverflow.com/questions/4295782/how-to-process-post-data-in-node-js">POST Daten mithilfe von Express auslesen</a></li>
</ul>

<blockquote>
  <p><strong>Hinweis</strong> Der Vollständigkeit halber soll an dieser Stelle nicht unerwähnt bleiben, dass es neben GET und POST noch weitere, teilweise ähnlich funktionierende Serveranfragen gibt, welche für spezielle Anfragen genutzt werden können: HEAD, PUT, PATCH, DELETE, OPTIONS, etc. Will man z.B. wie oben erwähnt eine Löschanweisung an den Server senden, so könnte man dies über POST machen, noch besser wäre es aber, eine DELETE Anfrage zu verwenden. Diese verschiedenen Arten von Anfragen sind auch als das <strong>REST Modell</strong> (Representational State Transfer) bekannt.</p>
</blockquote>

<p>Beispielcode Clientseite</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">serverAddress</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/plain</span><span class="dl">"</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">});</span>
</code></pre></div></div>
<p>Beispielcode Serverseite</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">_request</span><span class="p">.</span><span class="nx">method</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">body</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>
  <span class="nx">_request</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">data</span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">body</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="nx">_request</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">end</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="na">post</span><span class="p">:</span> <span class="kr">any</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="was-sie-jetzt-im-prinzip-können">Was Sie jetzt im Prinzip können:</h3>
<ul>
  <li>asynchrone Kommunikation</li>
  <li>Server-Client Kommunikation</li>
  <li>Daten
    <ul>
      <li>schicken</li>
      <li>empfangen</li>
      <li>aufbereiten</li>
      <li>umwandeln</li>
    </ul>
  </li>
</ul>

<p>Diese Tools sind bereits sehr mächtig und die Grundlage fast jeder App, Webseite u.ä.<br />
Mit diesem Wissen könnten Sie jetzt beginnen, ihre eigenen Webapps zu schreiben.</p>

<h3 id="typescript-dokumentation">Typescript Dokumentation</h3>

<p>https://www.typescriptlang.org/</p>

<hr />

<h2 id="-fragen-und-antworten"><strong>?!</strong> Fragen und Antworten</h2>

<p>(die Publikation der Zusammenfassung erfolgt nach dem Q&amp;A-Termin)</p>

<p>Zusammenfassung von: <a href="https://github.com/link-zu-github-profil">&lt;GitHub Nutzername&gt;</a></p>

<h3 id="erste-frage">Erste Frage?</h3>
<p>LoremLabore labore cillum mollit pariatur reprehenderit dolor laboris reprehenderit dolor sit officia ea non. Lorem reprehenderit exercitation labore eiusmod aute do nostrud officia aute proident sunt. Labore non tempor aliqua voluptate. Exercitation culpa officia ut aliqua nostrud laborum irure est. Minim eu sunt culpa adipisicing laborum consectetur aliqua quis.</p>

<h3 id="zweite-frage">Zweite Frage?</h3>
<p>Mollit aliquip veniam sit eiusmod tempor anim ipsum tempor. Aliqua sunt voluptate ea dolor. Nulla est mollit consectetur cupidatat ut cillum ipsum minim. Est ex et nulla laborum fugiat dolore. Aliquip laboris sint exercitation commodo dolor sint mollit qui sunt ipsum fugiat occaecat id enim.</p>

<h2>…</h2>

    <footer class="site-footer">
      <em><a href="../../index.html">Über diesen Kurs</a></em>
      <em><a href="../index.html">Lehrinhalte</a></em>
    </footer>
  </main>
</body>


<!-- Mirrored from hs-furtwangen.github.io/GIS-WiSe-2020-2021/content/L3.2/ by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 04 Dec 2020 16:50:33 GMT -->
</html>
